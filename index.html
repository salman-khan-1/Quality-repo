<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Report - Checking Goods</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body { font-size: 12px; margin: 0; padding: 10px; background-color: #f5f5f5; }
table { border: 1px solid #000; width: 100%; border-collapse: collapse; background-color: #fff; page-break-inside: avoid; font-size: 12px; }
table th, table td { border: 1px solid #000 !important; text-align: center; vertical-align: middle; word-break: break-word; }
table th { background-color: #a0a0a0 !important; font-weight: bold; }
table td { font-weight: 600 !important; padding: 9.5px 3px !important; }
table input { width: 100%; border: none; text-align: center; font-size: 13px; font-weight: 600; padding: 2px; background-color: transparent; }

.col-no { width: 30px; }
.col-name { width: 160px; }
.col-code { width: 105px; }
.col-invoice { width: 140px; }
.col-items { width: 70px; }
.col-qty { width: 50px; }
.col-qty-5 { width: 90px; }
.col-qty-wider { width: 80px; }

.header-info p { font-weight: bold; font-size: 13px; margin: 0; }
.header-info span[contenteditable] { border-bottom: 1px dotted #000; padding: 0 2px; min-width: 50px; display:inline-block; }
.signature { margin-top: 28px; width: 100%; display: flex; justify-content: flex-end; font-size: 14px; }
.signature span { border-top: 1px solid #000; padding-top: 5px; display: inline-block; min-width: 180px; text-align: center; }
.page-number { text-align: center; font-weight: bold; margin-bottom: 5px; }
.no-print { margin: 10px 0; }
.page-break { page-break-before: always; }

.autocomplete-list { position: absolute; border: 1px solid #ccc; background: #fff; z-index: 1000; max-height:150px; overflow-y:auto; }

@media print {
  @page { size: A4 landscape; margin: 5mm; margin-top:42px; }
  body { margin: 0; padding: 0; background-color: #fff; -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  .no-print { display: none; }
  #entrySection { display: none !important; }
  table th, table td { -webkit-print-color-adjust: exact; print-color-adjust: exact; }
  tr { page-break-inside: avoid; }
  table input { display: none; }
  .with-dash td:empty::after { content: "-"; display: block; }
}
</style>
</head>
<body>
<div class="container-fluid">

<!-- Action Buttons -->
<div class="no-print mb-2">
  <button class="btn btn-success" onclick="saveSpecialist()">Save Report</button>
  <button class="btn btn-primary" onclick="generateCombinedReport()">Generate Report</button>
  <button class="btn btn-danger" onclick="clearAllSpecialists()">Clear All Reports</button>
  <button class="btn btn-secondary" onclick="window.print()">Print</button>
  <button class="btn btn-warning" onclick="nextSet()">page +.</button>
  <button class="btn btn-info" onclick="resetNumbers()">Reset page</button>
  <button class="btn btn-outline-dark" onclick="backupSuppliers()">Backup Suppliers</button>
  <input type="file" id="restoreFile" style="display:none" onchange="restoreSuppliers(event)">
  <button class="btn btn-outline-secondary" onclick="document.getElementById('restoreFile').click()">Restore Suppliers</button>
  <button class="btn btn-outline-info" onclick="toggleAdminPanel()">Manage Suppliers</button>
</div>

<!-- Admin Panel -->
<div class="no-print">
<div id="adminPanel" style="display:none; margin-top:10px; background:#fff; border:1px solid #ccc; padding:10px; border-radius:8px;">
  <h6>Saved Suppliers</h6>
  <table class="table table-sm table-bordered">
    <thead><tr><th>Name</th><th>Code</th><th>Actions</th></tr></thead>
    <tbody id="adminTableBody"></tbody>
  </table>
</div>
</div>

<!-- Header -->
<div class="no-print">
<div class="d-flex justify-content-between align-items-start mb-2">
  <div class="header-info">
    <p>Date: <span id="editableDate" contenteditable="true"></span></p>
    <p>Store location: <span id="editableStore" contenteditable="true">جدة</span></p>
    <p>Quality specialist: <span id="specialistNamePlaceholder">—</span></p>
  </div>
  <div class="text-center flex-grow-1">
    <h6 class="fw-bold text-decoration-underline" style="font-size:13px; margin-top:10px;">
      Daily report of checking goods received from suppliers
    </h6>
  </div>
  <div class="text-end header-info">
    <p>Makhazen Alenayah</p>
    <p>Quality section</p>
  </div>
</div>
<div id="setInfo" class="page-number">Page 1</div>
</div>

<!-- Report Table -->
<div class="table-responsive" id="entrySection">
  <table class="table table-bordered table-sm" id="reportTable">
    <thead>
      <tr>
        <th rowspan="3" class="col-no">No.</th>
        <th colspan="2">Supplier</th>
        <th colspan="3">Invoice</th>
        <th colspan="10">Notes</th>
      </tr>
      <tr>
        <th rowspan="2" class="col-name">Name</th>
        <th rowspan="2" class="col-code">Code</th>
        <th rowspan="2" class="col-invoice">Invoice number</th>
        <th rowspan="2" class="col-items">Items</th>
        <th rowspan="2" class="col-qty-5">Qty.</th>
        <th colspan="2" class="col-items">Exp.</th>
        <th colspan="2" class="col-items">Damage</th>
        <th colspan="2" class="col-items">Shortage in quantity</th>
        <th colspan="2" class="col-items">Arabic language</th>
        <th colspan="2" class="col-items">Others</th>
      </tr>
      <tr>
        <th class="col-items">Items</th><th class="col-qty">Qty.</th>
        <th class="col-items">Items</th><th class="col-qty">Qty.</th>
        <th class="col-items">Items</th><th class="col-qty">Qty.</th>
        <th class="col-items">Items</th><th class="col-qty">Qty.</th>
        <th class="col-items">Items</th><th class="col-qty-wider">Qty.</th>
      </tr>
    </thead>
    <tbody>
      <script>
        for (let i = 1; i <= 12; i++) {
          document.write('<tr>'+
            '<td>'+i+'</td>'+
            '<td><input type="text" oninput="showSuggestionsName(this)" onblur="saveSupplierPair(this)"></td>'+
            '<td><input type="number" oninput="showSuggestionsCode(this)" onblur="saveSupplierPair(this)"></td>'+
            '<td><input type="text"></td>'+
            '<td><input type="number"></td>'+
            '<td><input type="number"></td>'+
            '<td><input type="number"></td>'+
            '<td><input type="number"></td>'+
            '<td><input type="number"></td>'+
            '<td><input type="number"></td>'+
            '<td><input type="number"></td>'+
            '<td><input type="number"></td>'+
            '<td><input type="number"></td>'+
            '<td><input type="number"></td>'+
            '<td><input type="number"></td>'+
            '<td><input type="text"></td>'+
          '</tr>');
        }
      </script>
    </tbody>
  </table>
</div>

<script>
// -------------------- DATE & NUMBERING --------------------
let currentSet = 0;
const editableDate = document.getElementById("editableDate");
const now = new Date();
editableDate.innerText = `${now.getDate()} ${now.toLocaleString('default',{month:'long'})} ${now.getFullYear()}`;

function updateNumbers() {
  document.querySelectorAll("#reportTable tbody tr").forEach((row, index) => {
    row.cells[0].innerText = index + 1 + (currentSet * 12);
  });
  document.getElementById("setInfo").innerText = `Page ${currentSet + 1}`;
}
function nextSet() { currentSet++; updateNumbers(); }
function resetNumbers() { currentSet = 0; updateNumbers(); }
function clearTable() { document.querySelectorAll("#reportTable tbody tr input").forEach(i=>i.value=""); }
</script>
<script>
// -------------------- SUPPLIERS STORAGE --------------------
let suppliers = JSON.parse(localStorage.getItem("suppliers")) || {}; // format: { code: name }

// Save supplier pair (onblur)
function saveSupplierPair(input) {
    const row = input.closest("tr");
    const name = row.cells[1].querySelector("input").value.trim();
    const code = row.cells[2].querySelector("input").value.trim();
    if (name && code) {
        suppliers[code] = name; // store as code -> name
        localStorage.setItem("suppliers", JSON.stringify(suppliers));
        refreshAdminPanel();
    }
}

// -------------------- SUGGESTIONS-ONLY AUTOCOMPLETE --------------------
function showSuggestionsName(input) {
    const query = input.value.trim().toLowerCase();
    const matches = Object.entries(suppliers)
        .filter(([code, name]) => name.toLowerCase().includes(query))
        .map(([code, name]) => ({name, code}));

    showSuggestions(input, matches);
}

function showSuggestionsCode(input) {
    const query = input.value.trim();
    const matches = Object.entries(suppliers)
        .filter(([code, name]) => code.startsWith(query))
        .map(([code, name]) => ({name, code}));

    showSuggestions(input, matches);
}

// Render suggestion list (click-only)
function showSuggestions(input, suggestions) {
    closeSuggestions();
    if (!suggestions.length) return;

    const list = document.createElement("div");
    list.className = "autocomplete-list";
    list.style.width = input.offsetWidth + "px";

    suggestions.forEach(item => {
        const option = document.createElement("div");
        option.textContent = `${item.name} (${item.code})`;
        option.style.padding = "4px";
        option.style.cursor = "pointer";

        option.onmousedown = () => {
            const row = input.closest("tr");
            row.cells[1].querySelector("input").value = item.name;
            row.cells[2].querySelector("input").value = item.code;
            saveSupplierPair(input);
            closeSuggestions();
        };

        list.appendChild(option);
    });

    input.parentNode.style.position = "relative";
    input.parentNode.appendChild(list);
}

// Close all suggestion lists
function closeSuggestions() {
    document.querySelectorAll(".autocomplete-list").forEach(el => el.remove());
}

document.addEventListener("click", closeSuggestions);

// -------------------- ADMIN PANEL --------------------
function toggleAdminPanel() {
    const panel = document.getElementById("adminPanel");
    panel.style.display = panel.style.display === "none" ? "block" : "none";
    refreshAdminPanel();
}

function refreshAdminPanel() {
    const tbody = document.getElementById("adminTableBody");
    tbody.innerHTML = "";
    Object.entries(suppliers).forEach(([code, name]) => {
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${name}</td><td>${code}</td>
            <td><button class="btn btn-sm btn-danger" onclick="deleteSupplier('${code}')">Delete</button></td>`;
        tbody.appendChild(tr);
    });
}

function deleteSupplier(code) {
    if (confirm("Delete supplier with code: " + code + "?")) {
        delete suppliers[code];
        localStorage.setItem("suppliers", JSON.stringify(suppliers));
        refreshAdminPanel();
    }
}

// -------------------- BACKUP & RESTORE --------------------
function backupSuppliers() {
    const data = JSON.stringify(suppliers);
    const blob = new Blob([data], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "suppliers-backup.json";
    a.click();
    URL.revokeObjectURL(url);
    alert("Suppliers backup downloaded!");
}

function restoreSuppliers(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = e => {
        try {
            const imported = JSON.parse(e.target.result);
            if (typeof imported === "object" && !Array.isArray(imported)) {
                suppliers = imported;
                localStorage.setItem("suppliers", JSON.stringify(suppliers));
                refreshAdminPanel();
                alert("Suppliers restored!");
            } else alert("Invalid file!");
        } catch (err) { alert("Error reading file!"); }
    };
    reader.readAsText(file);
}

// -------------------- SPECIALIST STORAGE --------------------
function saveSpecialist() {
    const rows = document.querySelectorAll("#reportTable tbody tr");
    let supplierRows = [];
    let numbers = [];
    rows.forEach(row => {
        let rowData = [];
        row.querySelectorAll("input").forEach(input => rowData.push(input.value.trim()));
        supplierRows.push(rowData);
        numbers.push(row.cells[0].innerText);
    });

    const hasAny = supplierRows.some(r => r.some(v => v !== ""));
    if (!hasAny) { alert("Enter at least one supplier."); return; }

    const specialistName = prompt("Enter Quality Specialist Name:");
    if (!specialistName) return;
    document.getElementById("specialistNamePlaceholder").innerText = specialistName;

    const storeName = document.getElementById("editableStore").innerText.trim();
    const enteredDate = editableDate.innerText.trim();

    let storedData = JSON.parse(localStorage.getItem("specialistsData")) || [];
    storedData.push({
        name: specialistName,
        store: storeName,
        date: enteredDate,
        suppliers: supplierRows,
        numbers: numbers,
        page: currentSet + 1
    });
    localStorage.setItem("specialistsData", JSON.stringify(storedData));

    alert(`Report saved for ${specialistName}`);
    clearTable(); resetNumbers();
}

// -------------------- REPORT GENERATION --------------------
function generateCombinedReport() {
    const container = document.getElementById("combinedReports");
    container.innerHTML = "";
    const specialistsData = JSON.parse(localStorage.getItem("specialistsData")) || [];
    if(specialistsData.length === 0) { alert("No saved specialists to generate report."); return; }

    specialistsData.forEach((spec, sIndex) => {
        if (sIndex > 0) container.innerHTML += '<div class="page-break"></div>';
        const pageDiv = document.createElement("div");
        pageDiv.innerHTML = `
          <div class="d-flex justify-content-between align-items-start mb-2">
            <div class="header-info">
              <p>Date: <span>${spec.date}</span></p>
              <p>Store location: ${spec.store}</p>
              <p>Quality specialist: ${spec.name}</p>
            </div>
            <div class="text-center flex-grow-1">
              <h6 class="fw-bold text-decoration-underline" style="font-size:13px; margin-top:10px;">
                Daily report of checking goods received from suppliers
              </h6>
            </div>
            <div class="text-end header-info">
              <p>Makhazen Alenayah</p>
              <p>Quality section</p>
            </div>
          </div>
          <div class="page-number">Page ${spec.page}</div>
          <table class="table table-bordered table-sm">
            <thead>${document.querySelector("#reportTable thead").innerHTML}</thead>
            <tbody></tbody>
          </table>
          <div class="signature"><span>Signature</span></div>
        `;
        container.appendChild(pageDiv);
        const tbody = pageDiv.querySelector("tbody");

        spec.suppliers.forEach((rowData, idx) => {
            const supplierName = rowData[0].trim();
            if (!supplierName) {
                tbody.innerHTML += `<tr><td>${spec.numbers[idx]}</td>` + rowData.map(() => `<td></td>`).join('') + `</tr>`;
            } else {
                const rowHTML = `<tr class="with-dash"><td>${spec.numbers[idx]}</td>` +
                    rowData.map(val => `<td>${val.trim() !== "" ? val : '-'}</td>`).join('') +
                    `</tr>`;
                tbody.innerHTML += rowHTML;
            }
        });
    });
    alert("Combined report generated! Each report will print on a separate page.");
}

// -------------------- CLEAR ALL --------------------
function clearAllSpecialists() {
  if (confirm("Clear ALL saved specialists’ reports?")) {
    localStorage.removeItem("specialistsData");
    clearTable();
    document.getElementById("combinedReports").innerHTML = "";
    resetNumbers();
    alert("All Reports cleared.");
  }
}

// initialize admin panel
refreshAdminPanel();
</script>
</body>
</html>
